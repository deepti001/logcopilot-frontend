import React, { useEffect, useMemo, useState } from "react";
import {
  Card, CardContent, CardDescription, CardHeader, CardTitle,
} from "./ui/card";
import { BadgeSeverity } from "./ui/badge-severity";
import { CardKPI } from "./ui/card-kpi";
import { ButtonIconOnly } from "./ui/button-icon-only";
import { Button } from "./ui/button";
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from "./ui/table";
import {
  Tooltip, TooltipContent, TooltipProvider, TooltipTrigger,
} from "./ui/tooltip";
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer,
} from "recharts";
import {
  AlertTriangle, Shield, Bug, TrendingUp, TrendingDown, Minus, Eye, Copy, ExternalLink, Sparkles,
} from "lucide-react";
import { motion, AnimatePresence } from "motion/react";
import { RemediationDrawer } from "./RemediationDrawer";
import { getVulnerabilities, suggestRemediation } from "../services/api";
import type { VulnerabilityDTO } from "../types/vulnerability";
import {
  VulnerabilityFilters,
  FilterState,
} from "./VulnerabilityFilters";
import { exportVulnerabilitiesToCSV } from "../utils/exportUtils";
import { suggestionKey } from "../utils/suggestions";

function toApiTimeframe(ui: string): "last-build" | "1d" | "1w" | "1m" {
  switch (ui) {
    case "1-day": return "1d";
    case "1-week": return "1w";
    case "1-month": return "1m";
    default: return "last-build";
  }
}

function formatIST(iso?: string | null) {
  if (!iso) return "-";
  try {
    return new Date(iso).toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
  } catch {
    return iso;
  }
}

type Row = VulnerabilityDTO & { aiSuggestion?: string };

interface PieData {
  name: "CRITICAL" | "HIGH" | "MEDIUM" | "LOW";
  count: number;
  color: string;
}

function CustomPieChart({ data }: { data: PieData[] }) {
  const size = 220;
  const center = size / 2;
  const outerR = 90;
  const innerR = 20;

  const total = data.reduce((s, d) => s + d.count, 0);
  if (total === 0) {
    return (
      <div className="h-[220px] flex items-center justify-center text-muted-foreground">
        No data
      </div>
    );
  }

  const nonZero = data.filter(d => d.count > 0);

  const arcPath = (startAngle: number, endAngle: number) => {
    const sx = center + outerR * Math.cos(startAngle);
    const sy = center + outerR * Math.sin(startAngle);
    const ex = center + outerR * Math.cos(endAngle);
    const ey = center + outerR * Math.sin(endAngle);
    const largeArc = endAngle - startAngle > Math.PI ? 1 : 0;

    const ix = center + innerR * Math.cos(endAngle);
    const iy = center + innerR * Math.sin(endAngle);
    const jx = center + innerR * Math.cos(startAngle);
    const jy = center + innerR * Math.sin(startAngle);
    const largeArcInner = largeArc;

    return `
      M ${sx} ${sy}
      A ${outerR} ${outerR} 0 ${largeArc} 1 ${ex} ${ey}
      L ${ix} ${iy}
      A ${innerR} ${innerR} 0 ${largeArcInner} 0 ${jx} ${jy}
      Z
    `;
  };

  if (nonZero.length === 1) {
    const only = nonZero[0];
    return (
      <svg width={size} height={size} className="drop-shadow-sm">
        <circle cx={center} cy={center} r={outerR} fill={only.color} />
        <circle cx={center} cy={center} r={innerR} fill="hsl(var(--card))" />
        <text x={center} y={center + 6} textAnchor="middle" className="text-lg font-bold fill-foreground">
          {total}
        </text>
      </svg>
    );
  }

  let cumulative = -Math.PI / 2;
  return (
    <svg width={size} height={size} className="drop-shadow-sm">
      {data.filter(d => d.count > 0).map((d, i) => {
        const angle = (d.count / total) * Math.PI * 2;
        const start = cumulative;
        const end = cumulative + angle;
        cumulative = end;
        return (
          <path key={i} d={arcPath(start, end)} fill={d.color} stroke="white" strokeWidth={1.5} />
        );
      })}
      <text x={center} y={center + 6} textAnchor="middle" className="text-lg font-bold fill-foreground">
        {total}
      </text>
    </svg>
  );
}

interface VulnerabilityDashboardProps {
  environment: string;
  release: string;
  timePeriod?: "last-build" | "1-day" | "1-week" | "1-month";
  activeFilters?: string[];
  onFiltersChange?: (filters: string[]) => void;
  onExportableRowsChange?: (rows: any[]) => void;
  seedSuggestions?: Record<string, string>; 
}

export function VulnerabilityDashboard({
  environment,
  release,
  timePeriod = "last-build",
  activeFilters = [],
  onFiltersChange,
  onExportableRowsChange,
  seedSuggestions,
}: VulnerabilityDashboardProps) {
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState<FilterState>({
    release: [], environment: [], repo: [], image: [], severity: [],
  });
  const [localSuggestions, setLocalSuggestions] = useState<Record<string, string>>({});

  // --- Sorting and Pagination state ---
  const [sortField, setSortField] = useState<"severity" | "firstSeen" | "cvss">("severity");
  const [sortDirection, setSortDirection] = useState<"asc" | "desc">("desc");
  const [currentPage, setCurrentPage] = useState(1);
  const rowsPerPage = 10;

  // Sync local filters with chips; truly reset on Clear All
  useEffect(() => {
    if (!activeFilters || activeFilters.length === 0) {
      setFilters({ release: [], environment: [], repo: [], image: [], severity: [] });
      return;
    }
    const next: FilterState = { release: [], environment: [], repo: [], image: [], severity: [] };
    for (const chip of activeFilters) {
      const [k, v] = chip.split(": ");
      if ((next as any)[k]) (next as any)[k].push(v);
    }
    setFilters(prev => (JSON.stringify(prev) === JSON.stringify(next) ? prev : next));
  }, [activeFilters]);

  // When filters or sort change, reset to page 1 to avoid empty pages
  useEffect(() => {
    setCurrentPage(1);
  }, [JSON.stringify(filters), sortField, sortDirection, environment, release, timePeriod]);

  // Fetch vulnerabilities
  useEffect(() => {
    let cancelled = false;
    (async () => {
      setLoading(true);
      try {
        const data = await getVulnerabilities({
          env: environment,
          release_id: release,
          timeframe: toApiTimeframe(timePeriod),
          severity: filters.severity.length ? filters.severity : undefined,
          repo: filters.repo[0],
          image: filters.image[0],
        });
        if (!cancelled) {
          const normalized = (data ?? []).map((v) => ({
            ...v,
            name: v.name || v.cve_id || "",
          })) as Row[];
          setRows(normalized);
        }
      } catch (e) {
        console.error("getVulnerabilities failed:", e);
        if (!cancelled) setRows([]);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, [environment, release, timePeriod, JSON.stringify(filters.severity), filters.repo[0], filters.image[0]]);

  // Filter options for chips
  const filterOptions = useMemo(() => {
    const repos = Array.from(new Set(rows.map(r => r.repo).filter(Boolean))) as string[];
    const images = Array.from(new Set(rows.map(r => r.image).filter(Boolean))) as string[];
    const severities = Array.from(new Set(rows.map(r => r.severity))).filter(Boolean) as string[];
    return {
      releases: release ? [release] : [],
      environments: environment ? [environment] : [],
      repos,
      images,
      severities: severities.length ? severities : ["CRITICAL","HIGH","MEDIUM","LOW"],
    };
  }, [rows, environment, release]);

  // Filtering + Sorting
  const filtered = useMemo(() => {
    const base = rows.filter((r) => {
      const okRel = !filters.release.length || (r.release_id && filters.release.includes(r.release_id));
      const okEnv = !filters.environment.length || filters.environment.includes(environment);
      const okRepo = !filters.repo.length || (r.repo && filters.repo.includes(r.repo));
      const okImg = !filters.image.length || (r.image && filters.image.includes(r.image));
      const okSev =
        !filters.severity.length ||
        (
          r.severity &&
          filters.severity.map(s => s.toUpperCase().trim())
            .includes((r.severity || "").toUpperCase().trim())
        );
      return okRel && okEnv && okRepo && okImg && okSev;
    });

    // --- Sorting logic ---
    const severityRank: Record<string, number> = { CRITICAL: 4, HIGH: 3, MEDIUM: 2, LOW: 1 };

    return [...base].sort((a, b) => {
      switch (sortField) {
        case "severity": {
          const aRank = severityRank[a.severity?.toUpperCase() || ""] || 0;
          const bRank = severityRank[b.severity?.toUpperCase() || ""] || 0;
          return sortDirection === "asc" ? aRank - bRank : bRank - aRank;
        }
        case "cvss": {
          const aScore = a.nvd_cvss_v3_score ?? a.cvss_score ?? 0;
          const bScore = b.nvd_cvss_v3_score ?? b.cvss_score ?? 0;
          return sortDirection === "asc" ? aScore - bScore : bScore - aScore;
        }
        case "firstSeen": {
          const aTime = new Date(a.first_seen_time ?? a.nvd_published_date ?? 0).getTime();
          const bTime = new Date(b.first_seen_time ?? b.nvd_published_date ?? 0).getTime();
          return sortDirection === "asc" ? aTime - bTime : bTime - aTime;
        }
        default:
          return 0;
      }
    });
  }, [rows, filters, environment, sortField, sortDirection]);

  useEffect(() => {
    // Push the current filtered+sorted rows up to parent for CSV export
    onExportableRowsChange?.(filtered);
  }, [filtered, onExportableRowsChange]);

  useEffect(() => {
    if (!seedSuggestions) return;
    setLocalSuggestions(prev => ({ ...prev, ...seedSuggestions }));
  }, [seedSuggestions]);

  function getAISuggestionForRow(v: any): string {
    const key = suggestionKey(v);
    return (
      localSuggestions[key] ||
      v.aiSuggestion ||      
      v.aiRecommendation ||  
      ""
    );
  }

  async function handleCopySuggestion(v: any) {
    const key = suggestionKey(v);
    let text = getAISuggestionForRow(v);

    // If missing, fetch and cache once
    if (!text) {
      try {
        const res = await suggestRemediation({
          name: v.name || v.cve_id || "",
          severity: v.severity || "",
          package_name: v.package_name,
          package_version: v.package_version,
          description: v.description || v.nvd_description || "",
        });
        text = res?.suggestion || "";
        if (text) {
          setLocalSuggestions(prev => ({ ...prev, [key]: text }));
        }
      } catch (e) {
        // swallow error; you can toast if you prefer
      }
    }

    if (text) {
      await navigator.clipboard.writeText(text);
      // show your toast/success
    }
  }


  // --- Pagination logic ---
  const totalPages = Math.max(1, Math.ceil((filtered?.length || 0) / rowsPerPage));
  const paginatedRows = useMemo(() => {
    const start = (currentPage - 1) * rowsPerPage;
    const end = currentPage * rowsPerPage;
    return filtered.slice(start, end);
  }, [filtered, currentPage]);

  // KPIs & Charts
  const severityCounts = useMemo(() => {
    const acc: Record<string, number> = {};
    for (const r of filtered) {
      const s = (r.severity || "UNKNOWN").toUpperCase();
      acc[s] = (acc[s] || 0) + 1;
    }
    return acc;
  }, [filtered]);

  const totalVulns = Object.values(severityCounts).reduce((a, b) => a + b, 0);
  const critHigh = (severityCounts.CRITICAL || 0) + (severityCounts.HIGH || 0);
  const hasMultipleImages =
    timePeriod !== "last-build" &&
    (new Set(filtered.map(r => r.image).filter(Boolean))).size > 1;

  const pieData: PieData[] = [
    { name: "CRITICAL", count: severityCounts.CRITICAL || 0, color: "var(--severity-critical)" },
    { name: "HIGH",     count: severityCounts.HIGH || 0,     color: "var(--severity-high)" },
    { name: "MEDIUM",   count: severityCounts.MEDIUM || 0,   color: "var(--severity-medium)" },
    { name: "LOW",      count: severityCounts.LOW || 0,      color: "var(--severity-low)" },
  ];

  const trendData = useMemo(() => {
    if (timePeriod === "last-build") return [];
    const days = timePeriod === "1-day" ? 1 : timePeriod === "1-week" ? 7 : 30;
    const out: { date: string; critical: number; high: number; medium: number; low: number }[] = [];
    for (let i = days - 1; i >= 0; i--) {
      const d = new Date(); d.setDate(d.getDate() - i);
      out.push({
        date: d.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
        critical: Math.floor(Math.random() * 3),
        high: Math.floor(Math.random() * 5),
        medium: Math.floor(Math.random() * 8),
        low: Math.floor(Math.random() * 10),
      });
    }
    return out;
  }, [timePeriod]);

  async function copySuggestion(row: Row) {
    try {
      let text = row.aiSuggestion;
      if (!text) {
        const res = await suggestRemediation({
          name: row.name || row.cve_id || "",
          severity: row.severity || "",
          package_name: row.package_name,
          package_version: row.package_version,
          description: row.description,
        });
        text = (res?.suggestion || "").trim();
        if (text) {
          setRows(prev => prev.map(r => (r.name === row.name ? { ...r, aiSuggestion: text! } : r)));
        }
      }
      if (!text) {
        window.alert("No suggestion generated.");
        return;
      }
      await navigator.clipboard.writeText(text);
      window.alert("Suggestion copied to clipboard");
    } catch (err: any) {
      console.error("copy remediation failed", err);
      window.alert(`Failed to copy suggestion: ${err?.message || err}`);
    }
  }

  const slideInVariants = {
    hidden: { opacity: 0, x: -30, y: 10, scale: 0.9, filter: "blur(4px)" },
    visible: { opacity: 1, x: 0, y: 0, scale: 1, filter: "blur(0px)", transition: { duration: 0.25, ease: [0.23, 1, 0.32, 1], staggerChildren: 0.1 } },
    exit: { opacity: 0, x: 30, y: -10, scale: 0.9, filter: "blur(4px)", transition: { duration: 0.2, ease: [0.23, 1, 0.32, 1] } },
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2>Docker Vulnerability Analysis</h2>
          <p className="text-muted-foreground">
            {timePeriod === "last-build" ? "Latest build analysis" : `Analysis for ${timePeriod.replace("-", " ")}`}
          </p>
        </div>
      </div>

      {/* KPIs */}
      <motion.div
        className={`grid grid-cols-1 gap-4 ${hasMultipleImages ? "md:grid-cols-3 lg:grid-cols-5" : timePeriod === "last-build" ? "md:grid-cols-5" : "md:grid-cols-2"}`}
        layout
        transition={{ duration: 0.25, ease: "easeInOut" }}
      >
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.1 }}>
          <CardKPI title="Total Vulnerabilities" value={totalVulns} icon={Bug}
                   subtitle={timePeriod === "last-build" ? "In current build" : `Across ${Math.max(1, (new Set(filtered.map(r => r.image).filter(Boolean))).size)} images`} />
        </motion.div>

        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.2 }}>
          <CardKPI title="Critical & High" value={critHigh} icon={AlertTriangle}
                   iconColor="text-red-500" subtitle="Action required" className="[&_.text-2xl]:text-red-600" />
        </motion.div>

        {timePeriod === "last-build" && (
          <>
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.3 }}>
              <CardKPI title="New since previous build" value={0} icon={TrendingUp} iconColor="text-blue-500" subtitle="Since previous build" />
            </motion.div>
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.4 }}>
              <CardKPI title="Resolved since previous build" value={0} icon={TrendingDown} iconColor="text-green-500" subtitle="Issues fixed" />
            </motion.div>
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4, delay: 0.5 }}>
              <CardKPI title="Unchanged" value={0} icon={Minus} iconColor="text-gray-500" subtitle="Persistent issues" />
            </motion.div>
          </>
        )}

        <AnimatePresence mode="wait" key={`images-${timePeriod}`}>
          {hasMultipleImages && (
            <motion.div key={`images-analyzed-${timePeriod}`} variants={slideInVariants} initial="hidden" animate="visible" exit="exit" layout>
              <CardKPI title="Images Analyzed"
                       value={(new Set(filtered.map(r => r.image).filter(Boolean))).size || 1}
                       icon={Shield} iconColor="text-green-500" subtitle="Docker images analyzed" />
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* Charts */}
      <motion.div className={`grid grid-cols-1 gap-6 ${hasMultipleImages ? "lg:grid-cols-2" : ""}`} layout transition={{ duration: 0.25, ease: "easeInOut" }}>
        <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 0.4, delay: 0.3 }}>
          <Card>
            <CardHeader>
              <CardTitle>Vulnerability Distribution</CardTitle>
              <CardDescription>
                {timePeriod === "last-build" ? "Current vulnerabilities by severity" : `Vulnerabilities by severity (${timePeriod.replace("-", " ")})`}
              </CardDescription>
            </CardHeader>
            <CardContent className="p-6">
              {totalVulns > 0 ? (
                <div className="space-y-4">
                  <div className="w-full h-[220px] flex items-center justify-center">
                    <CustomPieChart data={pieData} />
                  </div>
                  <div className="flex flex-wrap justify-center gap-4 h-[44px] items-center">
                    {pieData.map((item) => (
                      <div key={item.name} className="flex items-center gap-2">
                        <div className="w-4 h-4 rounded-full" style={{ backgroundColor: item.color }} />
                        <span className="text-sm font-medium">
                          {item.name} ({item.count})
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="flex flex-col items-center justify-center h-[200px] text-muted-foreground">
                  <h3 className="font-medium mb-1">No Vulnerabilities Found</h3>
                  <p className="text-sm text-center">
                    {Object.values(filters).some(v => v.length > 0)
                      ? "No vulnerabilities match the current filters"
                      : "No vulnerabilities detected in this period"}
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        </motion.div>

        <AnimatePresence mode="wait" key={`trends-${timePeriod}`}>
          {hasMultipleImages && (
            <motion.div key={`vulnerability-trends-${timePeriod}`} variants={slideInVariants} initial="hidden" animate="visible" exit="exit" layout>
              <Card>
                <CardHeader>
                  <CardTitle>Vulnerability Trends</CardTitle>
                  <CardDescription>Vulnerability count by severity over time</CardDescription>
                </CardHeader>
                <CardContent>
                  <ResponsiveContainer width="100%" height={302}>
                    <BarChart data={[] /* replace with real trend data when backend supports it */}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="date" />
                      <YAxis />
                      <RechartsTooltip />
                      <Bar dataKey="critical" stackId="a" fill="var(--severity-critical)" />
                      <Bar dataKey="high" stackId="a" fill="var(--severity-high)" />
                      <Bar dataKey="medium" stackId="a" fill="var(--severity-medium)" />
                      <Bar dataKey="low" stackId="a" fill="var(--severity-low)" />
                    </BarChart>
                  </ResponsiveContainer>
                </CardContent>
              </Card>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* Filters */}
      <div>
        <VulnerabilityFilters
          key={`${environment}-${release}-${timePeriod}`}
          filters={filters}
          onFiltersChange={(newFilters) => {
            setFilters(newFilters);
            if (onFiltersChange) {
              const chips: string[] = [];
              Object.entries(newFilters).forEach(([k, vals]) => {
                vals.forEach((v) => chips.push(`${k}: ${v}`));
              });
              onFiltersChange(chips);
            }
          }}
          availableOptions={filterOptions}
        />
      </div>

      {/* Table */}
      <div>
        <Card>
          <CardHeader>
            <CardTitle>
              {timePeriod === "last-build" ? "Build Vulnerabilities" : "Vulnerabilities Found"}
            </CardTitle>
            <CardDescription>
              {timePeriod === "last-build"
                ? "Vulnerabilities detected in current Docker build • Sorted by severity"
                : "Vulnerabilities detected in selected time period"}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>CVE</TableHead>
                  <TableHead>Package / Installed → Fixed</TableHead>

                  <TableHead
                    className="cursor-pointer select-none"
                    onClick={() => {
                      setSortField("severity");
                      setSortDirection(prev =>
                        sortField === "severity" && prev === "desc" ? "asc" : "desc"
                      );
                    }}
                  >
                    Severity {sortField === "severity" && (sortDirection === "asc" ? "↑" : "↓")}
                  </TableHead>

                  <TableHead>Repo / Image</TableHead>

                  <TableHead
                    className="cursor-pointer select-none"
                    onClick={() => {
                      setSortField("firstSeen");
                      setSortDirection(prev =>
                        sortField === "firstSeen" && prev === "desc" ? "asc" : "desc"
                      );
                    }}
                  >
                    First Seen {sortField === "firstSeen" && (sortDirection === "asc" ? "↑" : "↓")}
                  </TableHead>

                  <TableHead
                    className="cursor-pointer select-none"
                    onClick={() => {
                      setSortField("cvss");
                      setSortDirection(prev =>
                        sortField === "cvss" && prev === "desc" ? "asc" : "desc"
                      );
                    }}
                  >
                    CVSS {sortField === "cvss" && (sortDirection === "asc" ? "↑" : "↓")}
                  </TableHead>

                  <TableHead>Remediation (AI)</TableHead>
                  <TableHead>Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading && (
                  <TableRow>
                    <TableCell colSpan={8} className="text-muted-foreground">
                      Loading…
                    </TableCell>
                  </TableRow>
                )}
                {!loading && paginatedRows.length === 0 && (
                  <TableRow>
                    <TableCell colSpan={8} className="text-muted-foreground">
                      No vulnerabilities found.
                    </TableCell>
                  </TableRow>
                )}
                {!loading && paginatedRows.map((v) => {
                  const cve = v.name || v.cve_id || "-";
                  const pkg = v.package_name ?? "-";
                  const installed = v.package_version ?? "-";
                  const fixed = v.fixed_version ?? "Latest";
                  const repo = v.repo ?? "-";
                  const image = v.image ?? "-";
                  const firstSeen = v.first_seen_time || v.nvd_published_date || null;
                  const cvss = v.nvd_cvss_v3_score ?? v.cvss_score ?? null;
                  const aiText = getAISuggestionForRow(v);

                  return (
                    <TableRow key={`${cve}-${image}`}>
                      <TableCell className="font-mono text-sm">
                        {v.uri ? (
                          <a className="underline" href={v.uri} target="_blank" rel="noreferrer">{cve}</a>
                        ) : cve}
                      </TableCell>

                      <TableCell className="min-w-[200px]">
                        <div className="space-y-1">
                          <div className="font-mono text-sm">{pkg}</div>
                          <div className="text-xs text-muted-foreground">
                            {installed} → {fixed}
                          </div>
                        </div>
                      </TableCell>

                      <TableCell>
                        <BadgeSeverity severity={
                          (v.severity || "LOW").toLowerCase() as "critical"|"high"|"medium"|"low"
                        }/>
                      </TableCell>

                      <TableCell className="min-w-[150px]">
                        <div className="space-y-1">
                          <div className="text-sm">{repo}</div>
                          <div className="text-xs text-muted-foreground font-mono">{image}</div>
                        </div>
                      </TableCell>

                      <TableCell className="min-w-[150px]">
                        <div className="space-y-1">
                          <div className="font-mono text-sm">
                            {v.first_seen_build ?? "-"}
                          </div>
                          <div className="text-xs text-muted-foreground">
                            {formatIST(firstSeen)} {firstSeen ? "IST" : ""}
                          </div>
                        </div>
                      </TableCell>

                      <TableCell>
                        <span className="font-mono text-sm">
                          {cvss ?? "N/A"}
                        </span>
                        {v.nvd_cvss_v3_vector && (
                          <span title={v.nvd_cvss_v3_vector} className="ml-2 text-xs text-muted-foreground underline cursor-help">
                            vector
                          </span>
                        )}
                      </TableCell>

                      {/* Remediation column */}
                      <TableCell className="min-w-[220px]">
                        <div className="flex items-center gap-2">
                          <div className="flex-1 text-sm text-muted-foreground truncate">
                            {aiText ? aiText.split(".")[0] + "..." : "Click View/Copy to generate"}
                          </div>
                          <RemediationDrawer
                            vulnerability={v as any}
                            aiText={aiText} 
                          >
                            <Button variant="ghost" size="sm" className="h-7 px-2">
                              <Sparkles className="h-3 w-3 mr-1" />
                              View
                            </Button>
                          </RemediationDrawer>
                        </div>
                      </TableCell>

                      {/* Actions */}
                      <TableCell>
                        <div className="flex items-center gap-1">
                          <ButtonIconOnly
                            icon={Eye}
                            tooltip="View CVE at NVD"
                            variant="view"
                            onClick={() => window.open(v.uri || `https://nvd.nist.gov/vuln/detail/${cve}`, "_blank")}
                          />
                          <ButtonIconOnly
                            icon={Copy}
                            tooltip="Copy remediation"
                            variant="copy"
                            onClick={() => handleCopySuggestion(v)}
                          />
                          <ButtonIconOnly
                            icon={ExternalLink}
                            tooltip="Open at MITRE"
                            variant="default"
                            onClick={() => window.open(`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve}`, "_blank")}
                          />
                        </div>
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>

            {/* Pagination controls */}
            <div className="flex items-center justify-between mt-4 text-sm">
              <div>
                Showing {(currentPage - 1) * rowsPerPage + 1}–
                {Math.min(currentPage * rowsPerPage, filtered?.length || 0)} of {filtered?.length || 0}
              </div>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  disabled={currentPage === 1}
                  onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                >
                  Previous
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  disabled={currentPage >= totalPages}
                  onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                >
                  Next
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
